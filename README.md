# Backup to Yandex Cloud S3

Этот скрипт предназначен для резервного копирования файлов или директорий с возможностью архивирования из локальной системы на объектное хранилище Yandex Cloud S3. Для каждого файла перед загрузкой проверяется его наличие в хранилище, чтобы избежать дублирования. Логи всех операций записываются в файл `/var/log/backup_yandex.log`.

## Требования

- Установленная утилита `s3cmd`
- Настроенная конфигурация `s3cmd` для доступа к Yandex Cloud S3
- Права на запись в файл `/var/log/backup_yandex.log`
- Полный путь к утилите `s3cmd` или доступ к ней через переменные окружения

## Установка

1. Установите `s3cmd` на сервер:

   ```bash
   sudo apt update
   sudo apt install s3cmd
   ```

2. Для настройки S3cmd используйте команду `sudo s3cmd --configure`. Обязательно запускать с `sudo`, т.к. скрипт нужно запускать с его использованием, чтобы избежать настройки прав всех файлов. При запросе укажите значения для следующих параметров:

    Access Key — введите идентификатор ключа, который вы получили при генерации статического ключа.

    Secret Key — введите секретный ключ, который вы получили при генерации статического ключа.

    Default Region — введите `ru-central1`.

    Для работы с Object Storage всегда указывайте регион ru-central1. Другие значения региона могут привести к ошибке авторизации.

    S3 Endpoint — введите `storage.yandexcloud.net`.

    DNS-style bucket+hostname:port template for accessing a bucket — введите `%(bucket)s.storage.yandexcloud.net`.

    Значения остальных параметров оставьте без изменений.

Программа попытается установить соединение с Object Storage и получить список бакетов. В случае успеха, программа выведет Success. Your access key and secret key worked fine :-).

Команда s3cmd --configure сохранит настройки в файле ~/.s3cfg в формате:
```
[default]
access_key = id
secret_key = secretKey
bucket_location = ru-central1
host_base = storage.yandexcloud.net
host_bucket = %(bucket)s.storage.yandexcloud.net
```
При необходимости эти настройки можно изменить напрямую в файле. Также можно указать настройки при запуске программы с помощью соответствующих параметров.

Для корректной работы команд, управляющих хостингом статических сайтов, в конфигурационный файл необходимо вручную добавить параметр

`website_endpoint = http://%(bucket)s.website.yandexcloud.net`


3. Создайте файл логов и дайте права на запись:

   ```bash
   sudo touch /var/log/backup_yandex.log
   sudo chmod 666 /var/log/backup_yandex.log
   ```

4. Поместите скрипт в удобную директорию и сделайте его исполняемым:

   ```bash
   chmod +x /path/to/backup-script.sh
   ```

## Настройка

Для удобства использования нескольких источников и назначения можно создать конфигурационный файл, где для каждой директории можно указать:

- Путь к директории для резервного копирования
- Путь к бакету Yandex Cloud S3 для загрузки
- Нужно ли архивировать файлы перед загрузкой (`true/false`)

Пример файла конфигурации:

```text
/path/to/dir1 s3://backup-storage1/dir1-backup true
/path/to/dir2 s3://backup-storage1/dir2-backup false
```

Где:
- Первый столбец — путь к локальной директории или файлу
- Второй столбец — целевой бакет в Yandex Cloud S3
- Третий столбец — флаг (`true/false`), определяющий необходимость архивирования

## Использование

Запустите скрипт для резервного копирования:

```bash
sudo /path/to/backup-script.sh
```

Скрипт будет выполнять следующие шаги:
1. Чтение конфигурационного файла с информацией о директориях для бэкапа.
2. Если архивирование включено, директория будет заархивирована перед загрузкой.
3. Проверка, существует ли файл в хранилище Yandex Cloud.
4. Если файл не найден, он загружается в указанный бакет.
5. Логи записываются в файл `/var/log/backup_yandex.log`.

## Автоматизация с помощью Cron

Чтобы автоматизировать процесс резервного копирования, можно добавить этот скрипт в расписание Cron:

1. Откройте редактор cron:

   ```bash
   crontab -e
   ```

2. Добавьте строку для ежедневного запуска, например, в 2 часа ночи:

   ```bash
   0 2 * * * sudo /path/to/backup-script.sh
   ```

Теперь скрипт будет запускаться автоматически каждый день в 2 часа ночи.

## Логи

Все события, включая архивирование, проверки, загрузки и ошибки, записываются в файл `/var/log/backup_yandex.log`. Пример содержимого файла логов:

```
2024-10-11 14:00:00 - Backup process started.
2024-10-11 14:00:01 - Processing directory: /path/to/dir1
2024-10-11 14:00:02 - Archiving /path/to/dir1 to /home/username/tmp/dir1-2024-10-11.tar...
2024-10-11 14:00:03 - Archive created: dir1-2024-10-11.tar
2024-10-11 14:00:04 - Uploading dir1-2024-10-11.tar to Yandex Cloud S3...
2024-10-11 14:00:05 - Successfully uploaded: dir1-2024-10-11.tar
2024-10-11 14:00:06 - Temporary archive /home/username/tmp/dir1-2024-10-11.tar removed.
2024-10-11 14:00:07 - Backup process completed.
```

## Примечание

Если утилита `s3cmd` недоступна при запуске скрипта через `sudo`, укажите полный путь к ней в скрипте:

```bash
/usr/bin/s3cmd
```

Или используйте `sudo -E`, чтобы сохранить окружение пользователя:

```bash
sudo -E /path/to/backup-script.sh
```

## Лицензия

Этот проект распространяется под лицензией MIT.
```

### Обновления:
1. Добавлено описание конфигурационного файла для указания нескольких мест для резервного копирования.
2. Указаны примеры использования флага архивирования.
3. Добавлена информация о возможности указания полного пути к `s3cmd`.
4. Указаны команды для автоматического запуска через `cron`.
